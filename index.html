<!doctype html>
<html lang="ja">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Archit</title>
    <meta name="description" content="Archit">
    <meta name="author" content="YA">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        .alert {
            display: none;
        }

        .alert.show {
            display: block;
        }
    </style>
</head>

<body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <!-- Bootstrap Icons ( https://icons.getbootstrap.com/ ) -->
                <i class="bi bi-app-indicator"></i>
                Archit
            </a>
            <div class="d-flex align-items-center">
                <input class="form-control me-2" type="search" placeholder="検索キーワード" aria-label="Search"
                    id="icon-search-term">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="icon-search-ignorecase" title="Ignore case">
                </div>
                <button class="btn btn-outline-success" type="button" id="icon-search">Search</button>
            </div>
        </div>
    </nav>

    <!-- Alert -->
    <div class="alert alert-warning alert-dismissible fade" role="alert" id="alert-input-keyword">
        検索キーワードを入力してください。
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="alert alert-success alert-dismissible fade" role="alert" id="alert-copied">
        クリップボードにコピーしました。
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div id="image-list" class="card-group"></div>

    <!-- Footer -->
    <div class="container mt-5">
        <footer class="footer align-bottom text-muted text-center">
            Copyright &copy;
            <script type="text/javascript"> document.write(new Date().getFullYear());</script>
            YA All rights reserved.
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <script>
        const apiUri = 'list.json';
        const baseUri = 'https://archit.pages.dev/';

        let queries;

        const retrieveQueryDict = () => {
            const urlSearchParams = new URLSearchParams(window.location.search);
            return Object.fromEntries(urlSearchParams.entries());
        }

        const loadJson = (term = '', ignore_case = false) => {
            fetch(apiUri)
                .then(response => response.json())
                .then(json => {
                    const filtered = json.tree.filter(function (element, index, array) {
                        return (element.type == 'blob' && element.path.startsWith('asset/') && element.path.includes('.png'));
                    });

                    const filtered2 = filtered.filter(function (element, index, array) {
                        return ignore_case
                            ?
                            term.toLowerCase()
                                .split(/\s+/)
                                .map(t => element.path.toLowerCase().includes(t))
                                .every(t => t === true)
                            :
                            term.split(/\s+/)
                                .map(t => element.path.includes(t))
                                .every(t => t === true)
                    });

                    const sorted = filtered2.sort(function (a, b) {
                        const na = a.path.toUpperCase();
                        const nb = b.path.toUpperCase();
                        if (na < nb) {
                            return -1;
                        } else if (na > nb) {
                            return 1;
                        } else {
                            return 0;
                        }
                    });

                    let imageList = document.getElementById('image-list');
                    imageList.innerHTML = '';

                    sorted.forEach(element => {
                        let img = document.createElement('img');
                        img.alt = element.path;
                        img.className = 'img-thumbnail';
                        img.crossOrigin = "anonymous";
                        img.height = 64;
                        img.src = baseUri + element.path;
                        img.title = element.path;
                        img.width = 64;
                        img.onclick = (event) => {
                            const img = event.target;
                            const canvas = document.createElement('canvas');
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            const ctx = canvas.getContext('2d');

                            ctx.beginPath();
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            ctx.drawImage(img, 0, 0);
                            canvas.toBlob(async (blob) => {
                                const item = new ClipboardItem({
                                    'image/png': blob
                                });
                                await navigator.clipboard.write([item]);

                                document.getElementById('alert-copied').classList.add('show');
                                setTimeout(() => {
                                    document.getElementById('alert-copied').classList.remove('show');
                                }, 1000);
                            });
                        };

                        imageList.appendChild(img);
                    });
                });
        };

        window.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('.alert').forEach((alert) => new bootstrap.Alert(alert));

            let term = retrieveQueryDict()['term'];
            if (term) {
                bootstrap.Alert.getInstance(document.getElementById('alert-input-keyword')).close()

                loadJson(
                    term,
                    document.getElementById('icon-search-ignorecase').checked
                );
            } else {
                document.getElementById('alert-input-keyword').classList.add('show');
                setTimeout(() => {
                    bootstrap.Alert.getInstance(document.getElementById('alert-input-keyword')).close()
                }, 3000);
            }

            document.getElementById('icon-search').addEventListener('click', (event) => {
                loadJson(
                    document.getElementById('icon-search-term').value,
                    document.getElementById('icon-search-ignorecase').checked
                );
            });

            document.getElementById('icon-search-term').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('icon-search').dispatchEvent(new Event('click'));
                }
            });
        });
    </script>
</body>

</html><!-- Copyright (c) 2022 YA All rights reserved. -->